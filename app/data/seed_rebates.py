from datetime import date

from sqlalchemy.orm import Session

from app.models.rebate import RebateProgram, RetrofitType, RebateRetrofitType


RETROFIT_TYPES = [
    {"name": "heat_pump_air_source", "display_name": "Air-Source Heat Pump", "category": "heating"},
    {"name": "heat_pump_ground_source", "display_name": "Ground-Source Heat Pump", "category": "heating"},
    {"name": "heat_pump_mini_split", "display_name": "Mini-Split Heat Pump", "category": "heating"},
    {"name": "insulation_attic", "display_name": "Attic Insulation", "category": "insulation"},
    {"name": "insulation_wall", "display_name": "Wall Insulation", "category": "insulation"},
    {"name": "insulation_basement", "display_name": "Basement Insulation", "category": "insulation"},
    {"name": "windows_doors", "display_name": "Windows & Doors", "category": "windows_doors"},
    {"name": "solar_panels", "display_name": "Solar Panels", "category": "solar"},
    {"name": "solar_battery", "display_name": "Solar Battery Storage", "category": "solar"},
    {"name": "heat_pump_water_heater", "display_name": "Heat Pump Water Heater", "category": "water_heating"},
    {"name": "smart_thermostat", "display_name": "Smart Thermostat", "category": "controls"},
    {"name": "air_sealing", "display_name": "Air Sealing", "category": "air_sealing"},
    {"name": "ev_charger", "display_name": "EV Charger", "category": "electrical"},
    {"name": "heat_recovery_ventilator", "display_name": "Heat Recovery Ventilator (HRV)", "category": "ventilation"},
]

REBATE_PROGRAMS = [
    # ── Federal ──────────────────────────────────────────────
    {
        "name": "Oil to Heat Pump Affordability Program (OHPA)",
        "province": "FED",
        "provider": "Natural Resources Canada",
        "description": "Federal program helping homeowners switch from oil heating to electric heat pumps. Covers equipment, installation, and related electrical/mechanical upgrades.",
        "max_amount": 15000,
        "amount_description": "Up to $15,000 ($10,000 base + $5,000 provincial top-up in some provinces)",
        "eligibility_summary": "Homeowners with existing oil-fired heating systems in their primary residence. Available across Canada with enhanced funding in Atlantic provinces.",
        "how_to_apply": "1. Confirm oil heating system in home. 2. Register online at OHPA portal. 3. Get quotes from qualified contractors. 4. Complete installation. 5. Submit receipts for reimbursement.",
        "website_url": "https://natural-resources.canada.ca/energy-efficiency/homes/ohpa",
        "is_active": True,
        "end_date": date(2027, 12, 31),
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "heat_pump_mini_split"],
    },
    {
        "name": "Canada Greener Homes Grant",
        "province": "FED",
        "provider": "Natural Resources Canada",
        "description": "Federal grant for home energy efficiency retrofits. Covered insulation, windows, heat pumps, solar, and more. Required pre- and post-retrofit EnerGuide evaluations.",
        "max_amount": 5600,
        "amount_description": "Up to $5,600 ($5,000 retrofits + $600 for evaluations)",
        "eligibility_summary": "Program is CLOSED as of December 31, 2025. No longer accepting new applications.",
        "how_to_apply": "This program is no longer accepting applications. Consider provincial programs or the OHPA program instead.",
        "website_url": "https://natural-resources.canada.ca/energy-efficiency/homes/canada-greener-homes-initiative",
        "is_active": False,
        "end_date": date(2025, 12, 31),
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "solar_panels", "heat_pump_water_heater", "smart_thermostat", "air_sealing"],
    },
    {
        "name": "Canada Greener Homes Loan",
        "province": "FED",
        "provider": "Natural Resources Canada",
        "description": "Interest-free loan of up to $40,000 for home energy retrofits with 10-year repayment terms.",
        "max_amount": 40000,
        "amount_description": "Up to $40,000 interest-free loan (10-year term)",
        "eligibility_summary": "Program is CLOSED. Application intake ended October 1, 2025. Existing applications are still being processed.",
        "how_to_apply": "This program is no longer accepting applications.",
        "website_url": "https://natural-resources.canada.ca/energy-efficiency/homes/canada-greener-homes-loan",
        "is_active": False,
        "end_date": date(2025, 10, 1),
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "solar_panels"],
    },

    # ── Ontario ──────────────────────────────────────────────
    {
        "name": "Home Renovation Savings Program (HRSP)",
        "province": "ON",
        "provider": "Government of Ontario / Save on Energy",
        "description": "Ontario's main home energy retrofit rebate program offering two streams: an assessment-required bundled path (min 2 upgrades) and a simplified single-upgrade path.",
        "max_amount": 10000,
        "amount_description": "Up to $5,000 (natural gas homes) or $10,000 (other heating sources)",
        "eligibility_summary": "Ontario homeowners with a primary residence. Bundled path requires pre/post energy audit and minimum 2 upgrades. Simplified path available for single upgrades without audit.",
        "how_to_apply": "1. Choose assessment or simplified path. 2. For assessment path: book EnerGuide evaluation. 3. Complete eligible upgrades. 4. Submit application with receipts on Save on Energy portal.",
        "website_url": "https://www.saveonenergy.ca/homerenovationsavings",
        "is_active": True,
        "end_date": date(2026, 11, 30),
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "heat_pump_mini_split", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "solar_panels", "heat_pump_water_heater", "smart_thermostat", "air_sealing"],
    },
    {
        "name": "Enbridge Home Efficiency Rebate",
        "province": "ON",
        "provider": "Enbridge Gas",
        "description": "Rebates for natural gas heated homes in the Enbridge Gas service area for energy efficiency upgrades including insulation, thermostats, and heating equipment.",
        "max_amount": 5000,
        "amount_description": "Up to $5,000 in combined rebates",
        "eligibility_summary": "Enbridge Gas customers in Ontario with natural gas heating. Home must be in the Enbridge service territory.",
        "how_to_apply": "1. Verify Enbridge Gas account. 2. Complete eligible upgrades using qualified contractors. 3. Apply online at Enbridge portal with invoices and proof of purchase.",
        "website_url": "https://www.enbridgegas.com/ontario/rebates-energy-conservation/home-efficiency-rebate",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["insulation_attic", "insulation_wall", "insulation_basement", "smart_thermostat", "air_sealing"],
    },
    {
        "name": "Better Homes Kingston (PACE Loan)",
        "province": "ON",
        "provider": "City of Kingston",
        "description": "Property Assessed Clean Energy (PACE) financing program offering interest-free loans for home energy improvements. Repayment through property tax bill over up to 10 years.",
        "max_amount": 40000,
        "amount_description": "Up to $40,000 interest-free loan repaid through property taxes",
        "eligibility_summary": "Kingston homeowners. Loan repaid via property tax bill. Must be used for eligible energy efficiency or renewable energy improvements. Property must be in the City of Kingston.",
        "how_to_apply": "1. Verify eligibility on Better Homes Kingston portal. 2. Get a home energy assessment. 3. Select eligible upgrades. 4. Apply for financing. 5. Complete work and begin repayment through property taxes.",
        "website_url": "https://www.cityofkingston.ca/residents/better-homes-kingston",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "heat_pump_mini_split", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "solar_panels", "heat_pump_water_heater"],
    },
    {
        "name": "Better Homes Ottawa (PACE Loan)",
        "province": "ON",
        "provider": "City of Ottawa / Federation of Canadian Municipalities",
        "description": "Property Assessed Clean Energy (PACE) financing for home energy retrofits. Loans up to $125,000 or 10% of home value at 4.33% interest over 20 years, repaid through property tax bill.",
        "max_amount": 125000,
        "amount_description": "Up to $125,000 (or 10% of home value) loan at 4.33% interest, 20-year term",
        "eligibility_summary": "Ottawa homeowners. Loan amount capped at $125,000 or 10% of assessed home value, whichever is less. Repaid through Local Improvement Charges on property tax bill.",
        "how_to_apply": "1. Apply through Better Homes Ottawa portal. 2. Get a home energy assessment. 3. Select eligible improvements. 4. Receive financing approval. 5. Complete retrofits and begin repayment.",
        "website_url": "https://www.betterhomesottawa.ca/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "heat_pump_mini_split", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "solar_panels", "heat_pump_water_heater", "ev_charger"],
    },
    {
        "name": "Toronto Home Energy Loan Program (HELP)",
        "province": "ON",
        "provider": "City of Toronto",
        "description": "PACE-style financing program using Local Improvement Charges to fund home energy retrofits. Loan repaid through property tax bill.",
        "max_amount": 125000,
        "amount_description": "Up to $125,000 financing repaid through property tax Local Improvement Charges",
        "eligibility_summary": "Toronto homeowners. Financing secured through Local Improvement Charges on property. Covers a wide range of home energy efficiency and renewable energy improvements.",
        "how_to_apply": "1. Apply through Toronto HELP program. 2. Complete a home energy assessment. 3. Receive approved scope of work. 4. Complete improvements. 5. Loan repayment begins on property tax bill.",
        "website_url": "https://www.toronto.ca/services-payments/water-environment/environmental-grants-incentives/home-energy-loan-program-help/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "solar_panels", "heat_pump_water_heater"],
    },
    {
        "name": "Enbridge Gas Ontario Home Weatherization Rebate",
        "province": "ON",
        "provider": "Enbridge Gas",
        "description": "Rebates for weatherization improvements in natural gas heated homes in the Enbridge Gas service area, including attic and wall insulation, air sealing, and basement insulation.",
        "max_amount": 5000,
        "amount_description": "Up to $5,000 in combined weatherization rebates",
        "eligibility_summary": "Enbridge Gas customers in Ontario with natural gas heating. Must use approved contractors. Home must be in the Enbridge service territory.",
        "how_to_apply": "1. Verify Enbridge Gas account. 2. Book a home energy assessment. 3. Complete eligible weatherization upgrades. 4. Apply online at Enbridge portal with invoices.",
        "website_url": "https://www.enbridgegas.com/ontario/rebates-energy-conservation/home-weatherization-rebate",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["insulation_attic", "insulation_wall", "insulation_basement", "air_sealing"],
    },

    # ── British Columbia ─────────────────────────────────────
    {
        "name": "CleanBC Better Homes Program",
        "province": "BC",
        "provider": "Government of British Columbia",
        "description": "BC's flagship home energy retrofit program offering substantial rebates for switching from fossil fuel heating to heat pumps, plus insulation and window upgrades.",
        "max_amount": 16000,
        "amount_description": "Up to $16,000 for oil/propane to heat pump (income-qualified); up to $5,000 standard",
        "eligibility_summary": "BC homeowners. Property assessed value must be $1,230,000 or less for income-qualified stream. Must use a registered contractor. Apply within 6 months of invoice date.",
        "how_to_apply": "1. Check eligibility on Better Homes BC website. 2. Get quotes from registered contractors. 3. Complete installation. 4. Apply online within 6 months of final invoice.",
        "website_url": "https://www.betterhomesbc.ca/rebates/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": True,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "heat_pump_mini_split", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "heat_pump_water_heater"],
    },
    {
        "name": "BC Hydro Home Renovation Rebate",
        "province": "BC",
        "provider": "BC Hydro",
        "description": "Rebates for solar panel installations and battery storage for BC Hydro customers. Requires use of HPCN contractor members as of June 2026.",
        "max_amount": 10000,
        "amount_description": "Up to $5,000 for solar panels + up to $5,000 for battery storage",
        "eligibility_summary": "BC Hydro residential customers. Must use HPCN (Heat Pump Contractor Network) member contractor as of June 1, 2026.",
        "how_to_apply": "1. Get quotes from HPCN-registered contractors. 2. Complete solar/battery installation. 3. Apply through BC Hydro rebate portal.",
        "website_url": "https://www.bchydro.com/powersmart/residential/rebates-programs/home-renovation.html",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["solar_panels", "solar_battery"],
    },
    {
        "name": "FortisBC Home Renovation Rebates",
        "province": "BC",
        "provider": "FortisBC",
        "description": "Rebates from FortisBC for natural gas customers making energy efficiency upgrades. Separate from CleanBC, covers gas heating equipment, insulation, and other improvements for FortisBC gas customers.",
        "max_amount": 5000,
        "amount_description": "Up to $5,000 in combined rebates for gas efficiency upgrades",
        "eligibility_summary": "FortisBC natural gas customers in British Columbia. Covers insulation, windows, natural gas heating equipment, and related efficiency upgrades.",
        "how_to_apply": "1. Verify FortisBC gas account. 2. Complete eligible upgrades with qualified contractors. 3. Apply through FortisBC rebate portal with invoices.",
        "website_url": "https://www.fortisbc.com/rebates",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "air_sealing", "smart_thermostat"],
    },
    {
        "name": "FortisBC Dual Fuel System Rebate",
        "province": "BC",
        "provider": "FortisBC",
        "description": "Substantial rebate for installing a dual fuel heating system combining an electric heat pump with a natural gas furnace for backup. One of the highest utility rebates in BC.",
        "max_amount": 15000,
        "amount_description": "$10,000-$15,000 for heat pump + gas furnace dual fuel system",
        "eligibility_summary": "FortisBC natural gas customers in BC. Must install a qualifying dual fuel system (electric heat pump with gas furnace backup). Higher rebates for systems replacing older equipment.",
        "how_to_apply": "1. Verify FortisBC gas account. 2. Get quotes for dual fuel system from qualified contractors. 3. Complete installation. 4. Apply through FortisBC with invoices and system documentation.",
        "website_url": "https://www.fortisbc.com/rebates/home/dual-fuel",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_mini_split"],
    },
    {
        "name": "BC Hydro EV Charger Rebate",
        "province": "BC",
        "provider": "BC Hydro",
        "description": "Rebate for the purchase and installation of a Level 2 EV charger at home for BC Hydro residential customers.",
        "max_amount": 350,
        "amount_description": "$350 rebate for Level 2 EV charger installation",
        "eligibility_summary": "BC Hydro residential customers. Must purchase and install a qualifying Level 2 EV charger at a residential property.",
        "how_to_apply": "1. Purchase a qualifying Level 2 EV charger. 2. Have it installed at your home. 3. Apply through BC Hydro rebate portal with receipts.",
        "website_url": "https://www.bchydro.com/powersmart/electric-vehicles/charging/rebates.html",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["ev_charger"],
    },

    # ── Quebec ───────────────────────────────────────────────
    {
        "name": "Rénoclimat",
        "province": "QC",
        "provider": "Gouvernement du Québec",
        "description": "Quebec's long-running home energy efficiency program covering insulation, air sealing, windows, and doors. Requires mandatory pre- and post-energy evaluations.",
        "max_amount": 5000,
        "amount_description": "Varies by measure; up to $5,000 in combined rebates",
        "eligibility_summary": "Quebec homeowners. Mandatory pre- and post-retrofit energy evaluations required. Can be combined with Chauffez Vert and Hydro-Québec LogisVert programs.",
        "how_to_apply": "1. Register online. 2. Complete pre-retrofit energy evaluation. 3. Perform eligible upgrades. 4. Complete post-retrofit evaluation. 5. Receive rebate.",
        "website_url": "https://www.quebec.ca/en/housing-territory/heating-energy-consumption/financial-assistance-retrofits/renoclimat",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "air_sealing"],
    },
    {
        "name": "Chauffez Vert",
        "province": "QC",
        "provider": "Gouvernement du Québec",
        "description": "Quebec program for removing oil or propane furnaces and switching to electric heating systems. Closing March 31, 2026 — apply soon.",
        "max_amount": 5000,
        "amount_description": "Varies by conversion type; up to $5,000",
        "eligibility_summary": "Quebec homeowners with oil or propane heating systems. All work must be completed by March 31, 2026. Can be combined with Rénoclimat and Hydro-Québec LogisVert.",
        "how_to_apply": "1. Register before deadline. 2. Remove oil/propane system. 3. Install qualifying electric heating. 4. Submit documentation before March 31, 2026.",
        "website_url": "https://www.quebec.ca/en/housing-territory/heating-energy-consumption/financial-assistance-retrofits/chauffez-vert",
        "is_active": True,
        "end_date": date(2026, 3, 31),
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "heat_pump_mini_split"],
    },
    {
        "name": "Hydro-Québec LogisVert Program",
        "province": "QC",
        "provider": "Hydro-Québec",
        "description": "Hydro-Québec rebates for heat pump installations and dual-energy heating systems. Can be combined with Rénoclimat and Chauffez Vert provincial programs for maximum savings.",
        "max_amount": 22000,
        "amount_description": "Up to $6,700 for heat pumps; up to $22,000 for dual-energy systems",
        "eligibility_summary": "Hydro-Québec residential customers. Covers central and ductless heat pumps, and dual-energy heating systems. Can be combined with Quebec government programs.",
        "how_to_apply": "1. Verify Hydro-Québec account. 2. Get quotes from qualified contractors. 3. Complete heat pump or dual-energy installation. 4. Apply through Hydro-Québec LogisVert portal.",
        "website_url": "https://www.hydroquebec.com/residential/energy-wise/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "heat_pump_mini_split"],
    },
    {
        "name": "Éconologis Program",
        "province": "QC",
        "provider": "Gouvernement du Québec / Hydro-Québec",
        "description": "Free energy efficiency upgrades and advice for low-income Quebec households. Includes free installation of weatherstripping, low-flow showerheads, smart power bars, and thermostat adjustments.",
        "max_amount": None,
        "amount_description": "Free energy efficiency upgrades and advice (no cost to qualifying households)",
        "eligibility_summary": "Low-income Quebec households. Income eligibility based on household size and income thresholds set by the program. Covers renters and homeowners.",
        "how_to_apply": "1. Call Éconologis program to verify income eligibility. 2. Schedule a free home visit. 3. Energy advisor installs free upgrades and provides personalized advice.",
        "website_url": "https://www.quebec.ca/en/housing-territory/heating-energy-consumption/econologis",
        "is_active": True,
        "end_date": None,
        "is_income_tested": True,
        "retrofit_types": ["air_sealing", "smart_thermostat"],
    },

    # ── Alberta ──────────────────────────────────────────────
    {
        "name": "Clean Energy Improvement Program (CEIP)",
        "province": "AB",
        "provider": "Participating Alberta Municipalities",
        "description": "Property-assessed financing for energy efficiency upgrades at 3.75% interest for up to 20 years. Covers 100% of project costs with up to 10% incentive applied post-completion.",
        "max_amount": None,
        "amount_description": "100% project financing at 3.75% interest + up to 10% incentive off project costs",
        "eligibility_summary": "Homeowners in participating Alberta municipalities. Repayment through property tax bill. Available for a wide range of energy efficiency improvements.",
        "how_to_apply": "1. Verify your municipality participates. 2. Get a home energy assessment. 3. Select eligible upgrades. 4. Apply through CEIP portal. 5. Complete work and receive financing.",
        "website_url": "https://www.alberta.ca/clean-energy-improvement-program",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "solar_panels", "heat_pump_water_heater", "ev_charger"],
    },
    {
        "name": "CMHC Eco Improvement Program",
        "province": "AB",
        "provider": "Canada Mortgage and Housing Corporation",
        "description": "25% rebate on mortgage insurance premiums for homeowners completing $20,000+ in qualifying energy-efficient renovations. Available with CMHC-insured mortgages.",
        "max_amount": 5000,
        "amount_description": "25% of mortgage insurance premium (typically $2,000-$5,000+)",
        "eligibility_summary": "Homeowners with CMHC-insured mortgages completing at least $20,000 in qualifying energy efficiency renovations.",
        "how_to_apply": "1. Ensure mortgage is CMHC-insured. 2. Complete $20,000+ in eligible renovations. 3. Apply through CMHC for insurance premium refund.",
        "website_url": "https://www.cmhc-schl.gc.ca/professionals/project-funding-and-mortgage-financing/mortgage-loan-insurance/mortgage-loan-insurance-homeowning/cmhc-eco-improvement",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "solar_panels"],
    },

    # ── Nova Scotia ──────────────────────────────────────────
    {
        "name": "Nova Scotia OHPA Provincial Top-Up",
        "province": "NS",
        "provider": "Government of Nova Scotia / Natural Resources Canada",
        "description": "Provincial match to the federal OHPA program providing an additional $5,000 on top of the federal $10,000 for oil-to-heat-pump conversions. Funding expected to be fully committed in early 2026.",
        "max_amount": 15000,
        "amount_description": "Up to $15,000 total ($10,000 federal + $5,000 provincial)",
        "eligibility_summary": "Nova Scotia homeowners with oil heating. Must qualify for federal OHPA. Funding is limited — act quickly as program expected to be fully committed soon.",
        "how_to_apply": "1. Apply through the federal OHPA program. 2. Provincial top-up is applied automatically for eligible NS applicants.",
        "website_url": "https://natural-resources.canada.ca/energy-efficiency/homes/ohpa",
        "is_active": True,
        "end_date": date(2026, 6, 30),
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "heat_pump_mini_split"],
    },
    {
        "name": "HomeWarming Program",
        "province": "NS",
        "provider": "Efficiency Nova Scotia",
        "description": "Free energy upgrades for income-eligible Nova Scotia households including heat pumps, insulation, and air sealing.",
        "max_amount": None,
        "amount_description": "Free upgrades (no cost to qualifying homeowners)",
        "eligibility_summary": "Low-income Nova Scotia households. Income verification required. Covers single-family, semi-detached, townhouses, and mobile homes.",
        "how_to_apply": "1. Apply through Efficiency Nova Scotia. 2. Income verification. 3. Home assessment. 4. Free installation of eligible upgrades.",
        "website_url": "https://www.efficiencyns.ca/residential/homewarming/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": True,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_mini_split", "insulation_attic", "insulation_wall", "air_sealing"],
    },
    {
        "name": "Efficiency Nova Scotia - Home Energy Assessment Rebate",
        "province": "NS",
        "provider": "Efficiency Nova Scotia",
        "description": "Rebate program for Nova Scotia homeowners who complete a Home Energy Assessment (HEA). Assessment costs $199 (free for low-income non-electric fuel users). Based on assessment recommendations, receive rebates for completing eligible upgrades including heat pumps, insulation, windows, doors, and air sealing.",
        "max_amount": 10000,
        "amount_description": "Up to $5,000 per initiative, up to $10,000 total after completing recommended upgrades",
        "eligibility_summary": "Nova Scotia homeowners. Must complete a Home Energy Assessment ($199, free for qualifying low-income non-electric fuel users). Rebate amount depends on upgrades completed following assessment recommendations.",
        "how_to_apply": "1. Book a Home Energy Assessment through Efficiency Nova Scotia ($199). 2. Receive personalized upgrade recommendations. 3. Complete recommended upgrades with qualified contractors. 4. Submit documentation to claim rebates.",
        "website_url": "https://www.efficiencyns.ca/residential/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_mini_split", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "air_sealing"],
    },
    {
        "name": "Nova Scotia PACE / HRM Solar City",
        "province": "NS",
        "provider": "Halifax Regional Municipality / Clean Foundation",
        "description": "Property Assessed Clean Energy financing for clean energy improvements in participating Nova Scotia municipalities including Halifax Regional Municipality. Loan repaid through property tax bill.",
        "max_amount": 60000,
        "amount_description": "Financing for clean energy upgrades repaid through property tax bill",
        "eligibility_summary": "Homeowners in participating Nova Scotia municipalities (including Halifax Regional Municipality). Covers solar, heat pumps, and other clean energy improvements.",
        "how_to_apply": "1. Verify your municipality participates. 2. Apply through the Clean Foundation or municipal program. 3. Get approved for financing. 4. Complete eligible improvements. 5. Repayment through property taxes.",
        "website_url": "https://www.cleanfoundation.ca/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["solar_panels", "solar_battery", "heat_pump_air_source", "heat_pump_mini_split"],
    },

    # ── New Brunswick ────────────────────────────────────────
    {
        "name": "Total Home Energy Savings Program",
        "province": "NB",
        "provider": "Save Energy NB / Government of New Brunswick",
        "description": "Comprehensive energy savings program offering up to $15,000 in advance funding for home energy retrofits. Includes a discounted home energy evaluation ($99 instead of $600 value).",
        "max_amount": 15000,
        "amount_description": "Up to $15,000 in advance funding",
        "eligibility_summary": "New Brunswick homeowners. Home energy evaluation required ($99). Must complete work within 9 months of evaluation. Eligible upgrades include windows, doors, insulation, heating systems, and water heating.",
        "how_to_apply": "1. Book a home energy evaluation ($99). 2. Receive upgrade recommendations. 3. Complete eligible work within 9 months. 4. Post-retrofit evaluation. 5. Receive rebate/funding.",
        "website_url": "https://www.saveenergynb.ca/en/for-home/total-home-energy-savings-program/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "heat_pump_water_heater", "air_sealing"],
    },
    {
        "name": "NB Power Enhanced Energy Savings Program",
        "province": "NB",
        "provider": "NB Power",
        "description": "Enhanced energy savings program for lower-income New Brunswick households. Provides free or heavily subsidized energy efficiency upgrades for households earning under $70,000 annually.",
        "max_amount": None,
        "amount_description": "Free or heavily subsidized upgrades for qualifying households",
        "eligibility_summary": "New Brunswick households with annual income under $70,000. Must be an NB Power customer. Covers insulation, air sealing, and heating improvements.",
        "how_to_apply": "1. Verify income eligibility (under $70,000 annual). 2. Apply through NB Power. 3. Receive a free home energy assessment. 4. Approved upgrades installed at no cost or reduced cost.",
        "website_url": "https://www.nbpower.com/en/save-energy/residential/enhanced-energy-savings-program/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": True,
        "retrofit_types": ["insulation_attic", "insulation_wall", "insulation_basement", "air_sealing", "heat_pump_air_source", "heat_pump_mini_split"],
    },
    {
        "name": "NB Power Total Home Loan Program",
        "province": "NB",
        "provider": "NB Power",
        "description": "Low-interest financing from NB Power for home energy efficiency improvements. Loan repaid through NB Power bill.",
        "max_amount": 20000,
        "amount_description": "Up to $20,000 low-interest loan repaid through NB Power bill",
        "eligibility_summary": "NB Power residential customers. Covers energy efficiency upgrades including heat pumps, insulation, windows, and doors. Repaid through monthly NB Power bill.",
        "how_to_apply": "1. Apply through NB Power. 2. Get project pre-approved. 3. Complete eligible upgrades. 4. Loan repayment added to monthly NB Power bill.",
        "website_url": "https://www.nbpower.com/en/save-energy/residential/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_mini_split", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors"],
    },

    # ── Prince Edward Island ─────────────────────────────────
    {
        "name": "EfficiencyPEI Heat Pump Rebate",
        "province": "PE",
        "provider": "EfficiencyPEI / Government of PEI",
        "description": "Point-of-sale rebate for mini-split heat pump installations in PEI. Landlords also eligible as of June 2025.",
        "max_amount": 900,
        "amount_description": "$900 rebate per mini-split heat pump (point of sale)",
        "eligibility_summary": "PEI homeowners and landlords (as of June 2, 2025). Rebate applied at point of sale through participating retailers/installers.",
        "how_to_apply": "1. Purchase a qualifying mini-split heat pump from a participating retailer. 2. Rebate is applied automatically at point of sale.",
        "website_url": "https://www.princeedwardisland.ca/en/topic/efficiency-pei",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_mini_split"],
    },
    {
        "name": "PEI Energy Efficiency Loan Program",
        "province": "PE",
        "provider": "EfficiencyPEI / Government of PEI",
        "description": "Low-interest loan for energy efficiency upgrades covering 100% of pre-approved activity costs.",
        "max_amount": 10000,
        "amount_description": "Up to $10,000 loan at 5% interest over 7 years",
        "eligibility_summary": "PEI homeowners. Covers 100% of pre-approved energy efficiency improvement costs. 7-year repayment term at 5% interest.",
        "how_to_apply": "1. Apply through EfficiencyPEI. 2. Get project pre-approved. 3. Complete upgrades. 4. Loan repayment begins.",
        "website_url": "https://www.princeedwardisland.ca/en/topic/efficiency-pei",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_mini_split", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "heat_pump_water_heater"],
    },

    # ── Manitoba ─────────────────────────────────────────────
    {
        "name": "Efficiency Manitoba Home Energy Retrofit Program",
        "province": "MB",
        "provider": "Efficiency Manitoba",
        "description": "Rebates for home energy efficiency upgrades calculated based on energy savings achieved. Higher rebates for above-code performance.",
        "max_amount": None,
        "amount_description": "$75/GJ saved (standard) or $150/GJ saved (above code performance)",
        "eligibility_summary": "Manitoba homeowners. Rebate amount based on measured energy savings (GJ). All residential energy efficiency upgrades eligible.",
        "how_to_apply": "1. Register with Efficiency Manitoba. 2. Complete eligible upgrades. 3. Submit documentation of work completed. 4. Energy savings calculated and rebate issued.",
        "website_url": "https://efficiencymb.ca/my-home/home-energy-retrofit-program/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "insulation_attic", "insulation_wall", "insulation_basement", "air_sealing"],
    },
    {
        "name": "Manitoba Windows and Doors Rebate",
        "province": "MB",
        "provider": "Efficiency Manitoba",
        "description": "Per-unit rebate for ENERGY STAR certified windows and doors replacement.",
        "max_amount": 2000,
        "amount_description": "$100 per ENERGY STAR window or door (max $2,000)",
        "eligibility_summary": "Manitoba homeowners. Windows and doors must be ENERGY STAR certified. Maximum 20 units per household.",
        "how_to_apply": "1. Purchase and install ENERGY STAR certified windows/doors. 2. Apply through Efficiency Manitoba with receipts. 3. Rebate issued per qualifying unit.",
        "website_url": "https://efficiencymb.ca/my-home/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["windows_doors"],
    },
    {
        "name": "Manitoba Hydro Home Energy Efficiency Loan",
        "province": "MB",
        "provider": "Manitoba Hydro",
        "description": "Low-interest financing from Manitoba Hydro for home energy efficiency improvements. Loan repaid through Manitoba Hydro bill.",
        "max_amount": 12500,
        "amount_description": "Up to $12,500 financing repaid through Manitoba Hydro bill",
        "eligibility_summary": "Manitoba Hydro residential customers. Covers insulation, windows, doors, heating systems, and other energy efficiency improvements. Repaid through monthly Hydro bill.",
        "how_to_apply": "1. Verify Manitoba Hydro account. 2. Apply for loan through Manitoba Hydro. 3. Get approved scope of work. 4. Complete improvements with qualified contractors. 5. Repayment on monthly Hydro bill.",
        "website_url": "https://www.hydro.mb.ca/your_home/loans_financing/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors"],
    },
    {
        "name": "Efficiency Manitoba Energy Efficiency Assistance Program",
        "province": "MB",
        "provider": "Efficiency Manitoba",
        "description": "Free energy efficiency upgrades for income-eligible Manitoba households. Includes insulation, air sealing, and basic heating improvements at no cost.",
        "max_amount": None,
        "amount_description": "Free upgrades (no cost to qualifying households)",
        "eligibility_summary": "Low-income Manitoba households. Income verification required. Covers homeowners and renters in eligible dwelling types.",
        "how_to_apply": "1. Contact Efficiency Manitoba to verify income eligibility. 2. Schedule a free home energy assessment. 3. Approved upgrades installed at no cost.",
        "website_url": "https://efficiencymb.ca/my-home/energy-efficiency-assistance-program/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": True,
        "retrofit_types": ["insulation_attic", "insulation_wall", "insulation_basement", "air_sealing"],
    },

    # ── Saskatchewan ─────────────────────────────────────────
    {
        "name": "Home Efficiency Retrofit Rebate (HERR)",
        "province": "SK",
        "provider": "SaskEnergy / Government of Saskatchewan",
        "description": "Rebate for home energy retrofits including windows, doors, insulation, and air sealing. Note: program expiring soon.",
        "max_amount": 1800,
        "amount_description": "Up to $1,800 + additional $200 for EnerGuide evaluation subsidy",
        "eligibility_summary": "Saskatchewan homeowners registered under the program. Must complete eligible upgrades before program deadline. Pre/post EnerGuide evaluations subsidized.",
        "how_to_apply": "1. Register for the program. 2. Complete EnerGuide pre-evaluation. 3. Perform eligible upgrades. 4. Complete post-evaluation. 5. Receive rebate.",
        "website_url": "https://www.saskenergy.com/ways-save/home-efficiency-retrofit-rebate",
        "is_active": True,
        "end_date": date(2026, 3, 1),
        "is_income_tested": False,
        "retrofit_types": ["insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "air_sealing"],
    },
    {
        "name": "SaskPower Energy Efficiency Discounts Program",
        "province": "SK",
        "provider": "SaskPower",
        "description": "SaskPower discounts on energy-efficient equipment and upgrades for Saskatchewan residents. Covers heating, cooling, and electrical efficiency improvements.",
        "max_amount": 3000,
        "amount_description": "Varies by product; up to $3,000 in combined equipment discounts",
        "eligibility_summary": "SaskPower residential customers. Discounts on qualifying energy-efficient equipment purchased through participating retailers.",
        "how_to_apply": "1. Browse qualifying products on SaskPower website. 2. Purchase from participating retailers. 3. Discount applied at point of sale or submit rebate application.",
        "website_url": "https://www.saskpower.com/efficiency-programs-and-tips/efficiency-programs/residential-programs",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_mini_split", "smart_thermostat"],
    },
    {
        "name": "Saskatoon Home Energy Loan Program (HELP)",
        "province": "SK",
        "provider": "City of Saskatoon",
        "description": "PACE-style home energy loan program providing financing from $1,000 to $60,000 for energy efficiency and renewable energy upgrades. Repaid through property tax bill.",
        "max_amount": 60000,
        "amount_description": "$1,000-$60,000 loan repaid through property taxes",
        "eligibility_summary": "Saskatoon homeowners. Minimum loan $1,000, maximum $60,000. Covers energy efficiency and renewable energy improvements. Repaid through property tax bill.",
        "how_to_apply": "1. Apply through City of Saskatoon. 2. Get a home energy assessment. 3. Select eligible improvements. 4. Receive financing. 5. Complete work and begin property tax repayment.",
        "website_url": "https://www.saskatoon.ca/services-residents/power-water-sewer/saskatoon-home-energy-loan-program",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "solar_panels"],
    },

    # ── Newfoundland & Labrador ──────────────────────────────
    {
        "name": "TakeCHARGE Home Insulation Rebate",
        "province": "NL",
        "provider": "TakeCHARGE (NL Hydro / Newfoundland Power)",
        "description": "Rebates covering up to 75% of insulation costs for Newfoundland and Labrador homeowners.",
        "max_amount": 2000,
        "amount_description": "Up to 75% of insulation costs (max $2,000)",
        "eligibility_summary": "Newfoundland and Labrador homeowners who are NL Hydro or Newfoundland Power customers.",
        "how_to_apply": "1. Apply through TakeCHARGE program. 2. Get insulation work completed by qualified contractor. 3. Submit receipts for rebate processing.",
        "website_url": "https://takechargenl.ca/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["insulation_attic", "insulation_wall", "insulation_basement"],
    },
    {
        "name": "Newfoundland Oil to Electric Incentive",
        "province": "NL",
        "provider": "Government of Newfoundland and Labrador",
        "description": "Substantial rebate for homeowners converting from oil heating to electric heat pump systems. One of the highest single-program rebates in Canada.",
        "max_amount": 22000,
        "amount_description": "Up to $22,000 for oil-to-heat-pump conversion",
        "eligibility_summary": "Newfoundland and Labrador homeowners currently using oil heating. Must convert to qualifying heat pump system.",
        "how_to_apply": "1. Confirm current oil heating system. 2. Get quotes for heat pump installation. 3. Apply through provincial program. 4. Complete conversion. 5. Submit documentation for rebate.",
        "website_url": "https://www.gov.nl.ca/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "heat_pump_ground_source", "heat_pump_mini_split"],
    },
    {
        "name": "Home Energy Savings Program (HESP)",
        "province": "NL",
        "provider": "Government of Newfoundland and Labrador",
        "description": "Grants for low-income households to improve home energy efficiency.",
        "max_amount": 5000,
        "amount_description": "Up to $5,000 grant",
        "eligibility_summary": "Newfoundland and Labrador households with annual income of $32,500 or less. Single-family, row, and semi-detached homes (condos excluded).",
        "how_to_apply": "1. Verify income eligibility. 2. Apply through provincial program. 3. Home assessment. 4. Approved upgrades installed.",
        "website_url": "https://www.gov.nl.ca/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": True,
        "retrofit_types": ["insulation_attic", "insulation_wall", "insulation_basement", "windows_doors", "air_sealing"],
    },

    # ── Northwest Territories ────────────────────────────────
    {
        "name": "Arctic Energy Alliance Residential Rebate",
        "province": "NT",
        "provider": "Arctic Energy Alliance",
        "description": "Rebates for residential energy efficiency and renewable energy upgrades in the Northwest Territories.",
        "max_amount": 20000,
        "amount_description": "Up to $20,000 for residential projects",
        "eligibility_summary": "NWT residents. Applications accepted starting April 1, 2026. Covers a broad range of energy efficiency and renewable energy improvements.",
        "how_to_apply": "1. Check eligibility on Arctic Energy Alliance website. 2. Apply after April 1, 2026. 3. Complete approved upgrades. 4. Submit documentation for rebate.",
        "website_url": "https://aea.nt.ca/program/renewable-energy/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["heat_pump_air_source", "insulation_attic", "insulation_wall", "windows_doors", "solar_panels"],
    },

    # ── Yukon ────────────────────────────────────────────────
    {
        "name": "Yukon Good Energy Rebates",
        "province": "YT",
        "provider": "Government of Yukon",
        "description": "Rebates for solar and wind energy systems plus general energy efficiency upgrades for Yukon residents.",
        "max_amount": 5000,
        "amount_description": "$800/kW for solar/wind (max $5,000/year) plus efficiency upgrade rebates",
        "eligibility_summary": "Yukon residents. Solar and wind rebates at $800/kW up to $5,000 per year. Additional rebates for insulation, windows, and heating upgrades.",
        "how_to_apply": "1. Purchase and install qualifying system. 2. Apply through Yukon government energy program. 3. Provide installation documentation and receipts.",
        "website_url": "https://yukon.ca/en/energy-efficiency",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["solar_panels", "insulation_attic", "insulation_wall", "windows_doors", "heat_pump_air_source"],
    },

    # ── Nunavut ──────────────────────────────────────────────
    {
        "name": "Nunavut Energy Efficiency Programs",
        "province": "NU",
        "provider": "Government of Nunavut",
        "description": "Limited residential energy efficiency programs available through the territorial government. Programs primarily focus on government and community infrastructure but some residential support exists.",
        "max_amount": None,
        "amount_description": "Varies — contact Nunavut government for current availability",
        "eligibility_summary": "Nunavut residents. Limited residential programs available. Contact the Government of Nunavut for current program details and eligibility.",
        "how_to_apply": "Contact the Government of Nunavut's Department of Environment for current residential energy programs.",
        "website_url": "https://www.gov.nu.ca/",
        "is_active": True,
        "end_date": None,
        "is_income_tested": False,
        "retrofit_types": ["insulation_attic", "insulation_wall", "windows_doors"],
    },
]


def seed_database(db: Session) -> None:
    """Populate database with retrofit types and rebate program data."""
    if db.query(RebateProgram).count() > 0:
        return  # Already seeded

    # Insert retrofit types
    type_map: dict[str, int] = {}
    for rt_data in RETROFIT_TYPES:
        rt = RetrofitType(**rt_data)
        db.add(rt)
        db.flush()
        type_map[rt_data["name"]] = rt.id

    # Insert rebate programs with retrofit type associations
    for program_data in REBATE_PROGRAMS:
        data = {k: v for k, v in program_data.items() if k != "retrofit_types"}
        retrofit_names = program_data["retrofit_types"]
        program = RebateProgram(**data)
        db.add(program)
        db.flush()

        for rt_name in retrofit_names:
            assoc = RebateRetrofitType(
                rebate_id=program.id,
                retrofit_type_id=type_map[rt_name],
            )
            db.add(assoc)

    db.commit()
